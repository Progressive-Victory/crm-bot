steps:
  - name: "gcr.io/cloud-builders/docker"
    args:
      - "build"
      - "-t"
      - "gcr.io/$PROJECT_ID/discord-bot:$COMMIT_SHA"
      - "."

  - name: "gcr.io/cloud-builders/docker"
    args:
      - "push"
      - "gcr.io/$PROJECT_ID/discord-bot:$COMMIT_SHA"

  - name: "gcr.io/cloud-builders/gcloud"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        echo "Retrieving SSH key from Secret Manager..."
        gcloud secrets versions access latest --secret=cloud-build-ssh-key > id_rsa
        chmod 600 id_rsa

  - name: "ubuntu"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        ssh -i id_rsa -o StrictHostKeyChecking=no \
        cloud-build-deploy@discord-bot-dev.us-central1-a.compute.internal \
        "sudo docker pull gcr.io/$PROJECT_ID/discord-bot:$COMMIT_SHA &&
        sudo docker stop discord-container || true &&
        sudo docker rm discord-container || true &&
        sudo docker run -d --name discord-container gcr.io/$PROJECT_ID/discord-bot:$COMMIT_SHA"

options:
  logging: CLOUD_LOGGING_ONLY

secrets:
  - secretEnv:
      SSH_KEY: cloud-build-ssh-key
